<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Whoap</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.16.2/dist/phaser.js"></script>
    <style type="text/css">
        body {
            background-color: black;
            margin: 0px;
            padding: 0px;
            overflow: hidden;
        }
    </style>
</head>
<body>

<script>
    // tile size for 9x16 tiles is 80x80 px
    var resolution = 720; // 720p
    var tileSize = resolution / 9;
    var myTxt = null;
    //1200 x 1920 pixels

    // config of the game
    var removeAsteroidOnHit = true;
    var numberOfAsteroidsAtStart = 10;
    var shieldPowerAtStart = 5;

    class initScene extends Phaser.Scene {
        constructor() {
            super('initScene');
        }
        preload() {
            this.load.image('introbg', 'assets/img/intro.jpg');
            this.load.image('btn_cred', 'assets/img/buttoncredits.png');
            this.load.image('btn_play', 'assets/img/buttonplay.png');
        }
        create() {
            let bg = this.add.image(16 * resolution / (9 * 2), resolution / 2, 'introbg');
            let btn_play = this.add.sprite(16 * resolution / (9 * 2) - 160, resolution - tileSize, 'btn_play').setInteractive();
            let btn_cred = this.add.sprite(16 * resolution / (9 * 2) + 160, resolution - tileSize, 'btn_cred').setInteractive();
            var scene = this.scene;
            btn_cred.on('pointerdown', function (pointer) {
                scene.start('creditScene');
            });
            btn_play.on('pointerdown', function (pointer) {
                scene.start('boardScene');
            });
        }
        update() {
            // var pointer = this.input.activePointer;
            // if (pointer.leftButtonDown()) {
            //     this.scene.start('boardScene');
            // }
        }
    }

    class creditScene extends Phaser.Scene {

        constructor() {
            super('creditScene');
        }
        preload() {
            this.load.image('credits', 'assets/img/credits.png');
        }
        create() {
            let bg = this.add.image(16 * resolution / (9 * 2), resolution / 2, 'credits');
            this.timeout = 0;
        }
        update(time, delta) {
            this.timeout += delta;
            var pointer = this.input.activePointer;
            if (pointer.leftButtonDown() & this.timeout > 500) {
                this.scene.start('initScene');
            }
        }
    }

    class boardScene extends Phaser.Scene {
        constructor() {
            super('boardScene');
            this.gridLines;
            this.graphics;
            this.asteroids;
            this.asteroidsRotation;
            this.leftButtonPressed = false;
            this.leftButtonPressedTime;
            this.gameBoard;
            this.xplode;
            this.sfx_xplode;
            this.shield = shieldPowerAtStart;
            this.txt = null;
        }

        init() {
            //  Inject CSS
            var element = document.createElement('style');
            document.head.appendChild(element);
            var sheet = element.sheet;
            var styles = '@font-face { font-family: "membra"; src: url("assets/font/membra.otf") format("opentype"); }\n';
            sheet.insertRule(styles, 0);
        }

        preload() {
            this.load.script('webfont', 'https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js');
            this.load.image('goal', 'assets/img/goal.png');
            this.load.image('ship', 'assets/img/whoap_ship_80.png');
            this.load.image('asteroid01', 'assets/img/asteroid_80.png');
            this.load.image('bg', 'assets/img/backgroundwolaser.png');
            this.load.spritesheet('explosion', 'assets/img/explosion.png', {
                frameWidth: 64,
                frameHeight: 64,
                endFrame: 23
            });
            this.load.audio('sfx_xpl1', 'assets/sfx/xpl2.mp3');
        }

        create() {
            // init sound --------------
            this.sfx_xplode = this.sound.add('sfx_xpl1');

            // init text font ----
            let add = this.add;
            let input = this.input;
            let shield = this.shield;
            WebFont.load({
                custom: {
                    families: ['membra']
                },
                active: function () {
                    myTxt = add.text(tileSize / 2, tileSize / 2, 'Shield: ' + shield, {
                        fontFamily: 'membra',
                        fontSize: 64,
                        color: '#f205cb'
                    }).setShadow(2, 2, "#04bfad", 2, false, true);
                }
            });

            // init game board
            this.gameBoard = new Array(16);
            for (let x = 0; x < 16; x++) {
                this.gameBoard[x] = new Array(9);
                for (let y = 0; y < 9; y++) {
                    this.gameBoard[x][y] = 'e'; // e -> empty, a -> asteroid,
                }
            }
            // background
            let bg = this.add.image(16 * resolution / (9 * 2), resolution / 2, 'bg');
            bg.setScale(3, 3);
            bg.angle = 90;

            this.add.image(tileSize * 15 + tileSize / 2, tileSize * 3 + tileSize / 2, 'goal');
            this.add.image(tileSize * 15 + tileSize / 2, tileSize * 4 + tileSize / 2, 'goal');
            this.add.image(tileSize * 15 + tileSize / 2, tileSize * 5 + tileSize / 2, 'goal');
            // init ship ...
            this.shipSprite = this.add.sprite(0, 4 * tileSize, 'ship');
            this.shipSprite.setOrigin(0, 0);
            this.shipSprite.setPosition(this.tile2point(0, 4).x, this.tile2point(0, 4).y);

            // init asteroids
            this.asteroids = new Array();
            this.asteroidsRotation = new Array();
            for (let i = 0; i < 3; i++) {
                let a = this.add.sprite(0, 4 * tileSize, 'asteroid01');
                a.setOrigin(0.5, 0.5);
                let tileX=15, tileY=i;
                let aPos = this.tile2point(tileX, tileY);
                this.gameBoard[tileX][tileY] = 'a';
                a.setPosition(aPos.x + a.width / 2, aPos.y + a.height / 2);
                a.angle = Math.random() * 90;
                this.asteroids.push(a);
                this.asteroidsRotation.push(Math.random() - 0.5);
            }
            for (let i = 6; i < 9; i++) {
                let a = this.add.sprite(0, 4 * tileSize, 'asteroid01');
                a.setOrigin(0.5, 0.5);
                let tileX=15, tileY=i;
                let aPos = this.tile2point(tileX, tileY);
                this.gameBoard[tileX][tileY] = 'a';
                a.setPosition(aPos.x + a.width / 2, aPos.y + a.height / 2);
                a.angle = Math.random() * 90;
                this.asteroids.push(a);
                this.asteroidsRotation.push(Math.random() - 0.5);
            }
            for (let i = 0; i < numberOfAsteroidsAtStart; i++) {
                let a = this.add.sprite(0, 4 * tileSize, 'asteroid01');
                a.setOrigin(0.5, 0.5);
                let tileX, tileY;
                do {
                    /*
                    // Gauss distribution:
                    let ran = 0;
                    for (let k=0; k<12;k++) ran+=Math.random();
                    tileX = Math.floor(ran/12.0*14.0) + 1;
                    */
                    tileX = Math.floor(Math.random() * 14) + 1;
                    tileY = Math.floor(Math.random() * 9) + 1;
                } while (this.gameBoard[tileX][tileY] != 'e');
                let aPos = this.tile2point(tileX, tileY);
                this.gameBoard[tileX][tileY] = 'a';
                a.setPosition(aPos.x + a.width / 2, aPos.y + a.height / 2);
                a.angle = Math.random() * 90;
                this.asteroids.push(a);
                this.asteroidsRotation.push(Math.random() - 0.5);
            }


            // mouse click handler
            // this.input.on('pointerdown', mouseClicker, this);
            this.input.on('pointerdown', function (pointer) {

                this.leftButtonPressed = true;
                this.leftButtonPressedTime = 0;

            }, this);

            // init explosion ----
            let config = {
                key: 'explodeAnimation',
                frames: this.anims.generateFrameNumbers('explosion', {start: 0, end: 23, first: 23}),
                frameRate: 30,
                repeat: 0
            };
            this.anims.create(config);

            this.xplode = this.add.sprite(-50, -50, 'explosion');
            // xplode.play('explodeAnimation');

            // set up grid lines
            // var graphics = this.add.graphics();
            // graphics.lineGradientStyle(128, 0xff0000, 0xff0000, 0x0000ff, 0x0000ff, 1);
            this.graphics = this.add.graphics({lineStyle: {width: 1, color: 0xf2055c}});
            //graphics = this.add.graphics({lineStyle: {width: 1, color: 0xf20587}});

            this.gridLines = new Array();
            for (let i = 0; i < 16; i++)
                this.gridLines.push(new Phaser.Geom.Line(tileSize * i, 0, tileSize * i, resolution));
            for (let i = 0; i < 9; i++)
                this.gridLines.push(new Phaser.Geom.Line(0, tileSize * i, resolution / 9 * 16, tileSize * i));
        }

        update(time, delta) {
            // txt.text = ("haha");
            var pointer = this.input.activePointer;
            if (pointer.leftButtonDown()) {
                if (this.leftButtonPressed == false) {
                    this.leftButtonPressed = true;
                    this.leftButtonPressedTime = 0;
                } else {
                    this.leftButtonPressedTime += delta;
                    if (this.leftButtonPressedTime > 500) {
                        this.addAsteroid(pointer.x, pointer.y, this);
                    }
                }
            } else {

                if (this.leftButtonPressed == true & this.leftButtonPressedTime < 300) {
                    this.addShipTween(pointer.x, pointer.y, this)
                    // console.log(leftButtonPressedTime);
                }
                this.leftButtonPressed = false;
            }
            // shipSprite.setPosition(pointer.x-pointer.x%tileSize, pointer.y-pointer.y%tileSize);

            this.graphics.clear();
            for (const l of this.gridLines) {
                this.graphics.strokeLineShape(l);
            }

            // rotating asteroids:
            //asteroids[0].angle +=10;
            for (let i = 0; i < this.asteroids.length; i++) {
                this.asteroids[i].angle += this.asteroidsRotation[i];
            }

        }

        render() {
            // todo:
            // * shield
            // * mark goal area
            // * sound
        }


        addAsteroid(x, y, game) {
            let tileX = (x - x % tileSize) / tileSize;
            let tileY = (y - y % tileSize) / tileSize;
            // console.log(tileX + " " +tileY + " " + gameBoard[tileX][tileY]);
            if (this.gameBoard[tileX][tileY] == 'e') {
                // console.log("add asteroid!");
                let aPos = this.tile2point(tileX, tileY);
                let a = game.add.sprite(0, 4 * tileSize, 'asteroid01');
                a.setOrigin(0.5, 0.5);
                this.gameBoard[tileX][tileY] = 'a';
                a.setPosition(aPos.x + a.width / 2, aPos.y + a.height / 2);
                a.angle = Math.random() * 90;
                this.asteroids.push(a);
                this.asteroidsRotation.push(Math.random() - 0.5);
            }

        }

        addShipTween(x, y, game) {
            let tileX = Math.floor(x / tileSize);
            let tileY = Math.floor(y / tileSize);

            let shipSprite = this.shipSprite;
            let gameBoard = this.gameBoard;
            let xplode = this.xplode;

            let shipTileX = Math.floor(shipSprite.x / tileSize);
            let shipTileY = Math.floor(shipSprite.y / tileSize);
            let txt = this.txt;

            let canMove = true;
            if (Math.abs(shipTileX - tileX) + Math.abs(shipTileY - tileY) > 1) canMove = false;

            if (canMove && gameBoard[tileX][tileY] == 'e') {
                this.tween = game.tweens.add({
                    targets: shipSprite,
                    x: x - x % tileSize,
                    y: y - y % tileSize,
                    ease: 'Cubic',
                    duration: 250
                });
            } else if (canMove) { // runs into ASTEROID!
                // loose shield
                this.shield--;
                myTxt.text = 'Shield: ' + this.shield;
                this.xplode.setPosition(tileX * tileSize + tileSize / 2, tileY * tileSize + tileSize / 2);
                this.xplode.play('explodeAnimation');
                this.sfx_xplode.play();

                // find and eventually remove asteroid.
                let asteroid_idx=-1;
                for (let k=0; k< this.asteroids.length; k++) {
                    let a = this.asteroids[k];
                    if (Math.floor(a.x / tileSize) == tileX && Math.floor(a.y / tileSize) == tileY)
                        asteroid_idx = k;
                }
                if (removeAsteroidOnHit == true) { // remove asteroid:
                    this.asteroids[asteroid_idx].setPosition(-200, -200);
                    this.asteroids.splice(asteroid_idx, 1);
                    this.asteroidsRotation.splice(asteroid_idx, 1);
                    this.gameBoard[tileX][tileY] = 'e';
                }

                shipSprite.setPosition(tileX * tileSize, tileY * tileSize);
                this.tween = game.tweens.add({
                    targets: shipSprite,
                    x: shipTileX * tileSize,
                    y: shipTileY * tileSize,
                    ease: 'Cubic',
                    duration: 150
                });
                this.tween = game.tweens.add({
                    targets: xplode,
                    x: shipTileX * tileSize + tileSize / 2,
                    y: shipTileY * tileSize + tileSize / 2,
                    ease: 'Cubic',
                    duration: 150
                });
            }
        }

        tile2point(x, y) {
            return new Phaser.Geom.Point(x * tileSize, y * tileSize);
        }

        /*
    function mouseClicker(pointer) {

        if (pointer.leftButtonDown()) {
            // todo: add tween here ...
            // shipSprite.setPosition(pointer.x - pointer.x % tileSize, pointer.y - pointer.y % tileSize);
            this.tweens.add({
                targets: shipSprite,
                x: pointer.x - pointer.x % tileSize,
                y: pointer.y - pointer.y % tileSize,
                ease: 'Cubic',
                duration: 500
            });
        } else {

        }

    }


    */
    }

    var config = {
        type: Phaser.AUTO,
        scale: {
            mode: Phaser.Scale.FIT,
            parent: 'phaser-example',
            autoCenter: Phaser.Scale.CENTER_BOTH,
            width: 16 * resolution / 9,
            height: resolution,
        },

        scene: [initScene, boardScene, creditScene]
    };
    var game = new Phaser.Game(config);

</script>

</body>
</html>