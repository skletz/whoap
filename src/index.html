<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Whoap</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.16.2/dist/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script>
    // tile size for 9x16 tiles is 80x80 px
    var resolution = 720; // 720p
    var tileSize = resolution / 9;
    //1200 x 1920 pixels
    var config = {
        type: Phaser.AUTO,
        scale: {
            mode: Phaser.Scale.FIT,
            parent: 'phaser-example',
            autoCenter: Phaser.Scale.CENTER_BOTH,
            width: 16 * resolution / 9,
            height: resolution,
        },

        scene: {
            preload: preload,
            create: create,
            update: update,
            render: render
        }
    };
    var game = new Phaser.Game(config);
    var gridLines;
    var graphics;
    var asteroids, asteroidsRotation;
    var leftButtonPressed = false;
    var leftButtonPressedTime;

    var gameBoard;
    var xplode;

    var shield = 5;

    function preload() {
        this.load.image('ship', 'assets/img/ship1a.png');
        this.load.image('asteroid01', 'assets/img/asteroid_80.png');
        this.load.image('bg', 'assets/img/backgroundwolaser.png');
        this.load.spritesheet('explosion', 'assets/img/explosion.png', { frameWidth: 64, frameHeight: 64, endFrame: 23 });
    }

    function create() {

        // init game board
        gameBoard = new Array(16);
        for (let x = 0; x < 16; x++) {
            gameBoard[x] = new Array(9);
            for (let y = 0; y < 9; y++) {
                gameBoard[x][y] = 'e'; // e -> empty, a -> asteroid,
            }
        }
        // background
        let bg = this.add.image( 16 * resolution / (9*2), resolution/2, 'bg');
        bg.setScale(3, 3);
        bg.angle = 90;
        // init ship ...
        shipSprite = this.add.sprite(0, 4 * tileSize, 'ship');
        shipSprite.setOrigin(0, 0);
        shipSprite.setPosition(tile2point(0, 4).x, tile2point(0, 4).y);

        // init asteroids
        asteroids = new Array();
        asteroidsRotation = new Array();
        for (let i = 0; i < 10; i++) {
            let a = this.add.sprite(0, 4 * tileSize, 'asteroid01');
            a.setOrigin(0.5, 0.5);
            let tileX, tileY;
            do {
                tileX = Math.floor(Math.random() * 14) + 1;
                tileY = Math.floor(Math.random() * 9) + 1;
            } while (gameBoard[tileX][tileY]!='e');
            let aPos = tile2point(tileX, tileY);
            gameBoard[tileX][tileY] = 'a';
            a.setPosition(aPos.x+a.width/2, aPos.y+a.height/2);
            a.angle = Math.random()*90;
            asteroids.push(a);
            asteroidsRotation.push(Math.random()-0.5);
        }


        // mouse click handler
        // this.input.on('pointerdown', mouseClicker, this);
        this.input.on('pointerdown', function (pointer) {

            leftButtonPressed = true;
            leftButtonPressedTime = 0;

        }, this);

        // init explosion ----
        let config = {
            key: 'explodeAnimation',
            frames: this.anims.generateFrameNumbers('explosion', { start: 0, end: 23, first: 23 }),
            frameRate: 30,
            repeat: 0
        };
        this.anims.create(config);

        xplode = this.add.sprite(-50, -50, 'explosion');
        // xplode.play('explodeAnimation');

        // set up grid lines
        // var graphics = this.add.graphics();
        // graphics.lineGradientStyle(128, 0xff0000, 0xff0000, 0x0000ff, 0x0000ff, 1);
        graphics = this.add.graphics({lineStyle: {width: 1, color: 0xf2055c}});
        //graphics = this.add.graphics({lineStyle: {width: 1, color: 0xf20587}});

        gridLines = new Array();
        for (let i = 0; i < 16; i++)
            gridLines.push(new Phaser.Geom.Line(tileSize * i, 0, tileSize * i, resolution));
        for (let i = 0; i < 9; i++)
            gridLines.push(new Phaser.Geom.Line(0, tileSize * i, resolution / 9 * 16, tileSize * i));
    }

    function update(time, delta) {

        var pointer = this.input.activePointer;
        if (pointer.leftButtonDown()) {
            if (leftButtonPressed == false) {
                leftButtonPressed = true;
                leftButtonPressedTime = 0;
            } else {
                leftButtonPressedTime += delta;
                if (leftButtonPressedTime > 500) {
                    addAsteroid(pointer.x, pointer.y, this);
                }
            }
        } else {

            if (leftButtonPressed == true & leftButtonPressedTime < 300) {
                addShipTween(pointer.x, pointer.y, this)
                // console.log(leftButtonPressedTime);
            }
            leftButtonPressed = false;
        }
        // shipSprite.setPosition(pointer.x-pointer.x%tileSize, pointer.y-pointer.y%tileSize);

        graphics.clear();
        gridLines.forEach(function (l) {
            graphics.strokeLineShape(l);
        });

        // rotating asteroids:
        //asteroids[0].angle +=10;
        for (let i =0 ; i< asteroids.length; i++) {
            asteroids[i].angle += asteroidsRotation[i];
        }

    }

    function render() {
        // todo:
        // * shield
        // * mark goal area
        // * sound
    }


    function addAsteroid(x, y, game) {
        let tileX = (x-x%tileSize)/tileSize;
        let tileY = (y-y%tileSize)/tileSize;
        // console.log(tileX + " " +tileY + " " + gameBoard[tileX][tileY]);
        if (gameBoard[tileX][tileY]=='e') {
            // console.log("add asteroid!");
            let aPos = tile2point(tileX, tileY);
            let a = game.add.sprite(0, 4 * tileSize, 'asteroid01');
            a.setOrigin(0.5, 0.5);
            gameBoard[tileX][tileY] = 'a';
            a.setPosition(aPos.x+a.width/2, aPos.y+a.height/2);
            a.angle = Math.random()*90;
            asteroids.push(a);
            asteroidsRotation.push(Math.random()-0.5);
        }

    }

    function addShipTween(x, y, game) {
        let tileX = Math.floor(x/tileSize);
        let tileY = Math.floor(y/tileSize);

        let shipTileX = Math.floor(shipSprite.x/tileSize);
        let shipTileY = Math.floor(shipSprite.y/tileSize);

        let canMove = true;
        if (Math.abs(shipTileX-tileX) + Math.abs(shipTileY-tileY)>1) canMove = false;

        if (canMove && gameBoard[tileX][tileY]=='e') {
            tween = game.tweens.add({
                targets: shipSprite,
                x: x - x % tileSize,
                y: y - y % tileSize,
                ease: 'Cubic',
                duration: 250
            });
        } else if (canMove) { // runs into ASTEROID!
            // loose shield
            shield--;
            xplode.setPosition(tileX*tileSize + tileSize/2, tileY*tileSize+tileSize/2);
            xplode.play('explodeAnimation');
            shipSprite.setPosition(tileX*tileSize, tileY*tileSize);
            tween = game.tweens.add({
                targets: shipSprite,
                x: shipTileX*tileSize,
                y: shipTileY*tileSize,
                ease: 'Cubic',
                duration: 150
            });
            tween = game.tweens.add({
                targets: xplode,
                x: shipTileX*tileSize + tileSize/2,
                y: shipTileY*tileSize + tileSize/2,
                ease: 'Cubic',
                duration: 150
            });
        }
    }

    function tile2point(x, y) {
        return new Phaser.Geom.Point(x * tileSize, y * tileSize);
    }

    /*
    function mouseClicker(pointer) {

        if (pointer.leftButtonDown()) {
            // todo: add tween here ...
            // shipSprite.setPosition(pointer.x - pointer.x % tileSize, pointer.y - pointer.y % tileSize);
            this.tweens.add({
                targets: shipSprite,
                x: pointer.x - pointer.x % tileSize,
                y: pointer.y - pointer.y % tileSize,
                ease: 'Cubic',
                duration: 500
            });
        } else {

        }

    }


    */

</script>

</body>
</html>